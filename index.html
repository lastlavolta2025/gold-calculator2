<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>景輝金鋪計算器 (HKD)</title>
  <style>
    body {
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      max-width: 600px;
      margin: auto;
      padding: 15px 10px;
      background: #fff;
      color: #333;
      font-size: 16px;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 1em;
    }
    .hidden {
      display: none;
    }
    button {
      margin: 8px 5px;
      padding: 12px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background-color: #0275d8;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 5px rgb(2 117 216 / 0.6);
      transition: background-color 0.3s ease;
      width: 100%;
      max-width: 250px;
    }
    button:hover {
      background-color: #025aa5;
    }
    label {
      display: block;
      margin: 12px 0 6px 0;
      font-weight: 600;
    }
    input[type="tel"], input[type="number"] {
      width: 100%;
      padding: 8px 10px;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    input[type="number"]:focus, input[type="tel"]:focus {
      border-color: #0275d8;
      outline: none;
    }
    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin: 12px 0 5px;
    }
    .checkbox-group label {
      font-weight: normal;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .result {
      margin-top: 18px;
      font-weight: 700;
      font-size: 1.3rem;
      color: #d9534f;
      text-align: center;
      min-height: 4em;
      line-height: 1.3em;
      white-space: pre-wrap;
    }
    .price-refresh {
      cursor: pointer;
      color: #0275d8;
      text-decoration: underline;
      margin-left: 10px;
      font-weight: normal;
      font-size: 0.9rem;
    }
    #homepage {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin-top: 2em;
    }
    @media (max-width: 480px) {
      body {
        padding: 10px 5px;
        font-size: 14px;
      }
      button {
        padding: 10px 15px;
        font-size: 1rem;
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>景輝金鋪計算器 (HKD)</h1>

  <div id="homepage">
    <button id="btnBuyIn">買入計算器</button>
    <button id="btnSellOut">賣出計算器</button>
  </div>

  <div id="buyInCalc" class="hidden">
    <h2>買入計算器</h2>

    <div>
      <label>即時金價 (HKD/兩): 
        <span id="buyInLivePrice">讀取中...</span>
        <span id="buyInRefresh" class="price-refresh">重新整理</span>
      </label>
      <div class="checkbox-group" style="margin-top: 6px;">
        <label><input type="checkbox" id="premium500" checked /> 從即時金價扣HK$500</label>
        <label><input type="checkbox" id="premium1000" /> 從即時金價扣HK$1000</label>
      </div>
    </div>

    <label for="dailyPriceBuyIn">每日景輝金價 (HKD/兩):</label>
    <input type="tel" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="dailyPriceBuyIn" />

    <label for="weightBuyIn">重量 (毫兩):</label>
    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="weightBuyIn" placeholder="請輸入毫兩 (1000毫兩=1兩)" />

    <label for="discountBuyIn">折扣 (%) (例如輸入94等於0.94倍):</label>
    <input type="tel" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="discountBuyIn" placeholder="預設為100表示無折扣" />

    <div class="checkbox-group">
      <label><input type="checkbox" id="commissionBuyIn" checked /> 扣除2%佣金（買入用）</label>
    </div>

    <div>
      <label>金子純度 (%):</label>
      <label><input type="radio" name="purityBuyIn" value="100" checked /> 100%</label>
      <label><input type="radio" name="purityBuyIn" value="75" /> 75%</label>
      <label>
        <input type="radio" name="purityBuyIn" value="custom" /> 自訂純度:
        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="customPurityBuyIn" min="0" max="100" disabled placeholder="0 ~ 100" />
      </label>
    </div>

    <label for="counterofferBuyIn">客戶還價 (HKD):</label>
    <input type="tel" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="counterofferBuyIn" placeholder="輸入客戶還價計算利潤" />

    <button id="calcBuyIn">計算</button>
    <button id="resetBuyIn" style="background-color:#6c757d; margin-top: 5px;">重設</button>

    <div class="result" id="resultBuyIn"></div>
    <button id="backFromBuyIn" style="background-color:#5bc0de; margin-top: 20px;">返回主頁</button>
  </div>

  <div id="sellOutCalc" class="hidden">
    <h2>賣出計算器</h2>

    <div>
      <label>即時金價 (HKD/兩): 
        <span id="sellOutLivePrice">讀取中...</span>
        <span id="sellOutRefresh" class="price-refresh">重新整理</span>
      </label>
    </div>

    <label for="dailyPriceSellOut">每日景輝金價 (HKD/兩):</label>
    <input type="tel" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="dailyPriceSellOut" />

    <label for="weightSellOut">重量 (毫兩):</label>
    <input type="tel" inputmode="numeric" pattern="[0-9]*" id="weightSellOut" placeholder="請輸入毫兩 (1000毫兩=1兩)" />

    <div class="checkbox-group">
      <label><input type="checkbox" id="commissionSellOut" checked /> 加2%佣金（賣出用）</label>
    </div>

    <label for="labourCost">人工費 (HKD):</label>
    <input type="tel" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="labourCost" />

    <div class="checkbox-group">
      <label><input type="checkbox" id="creditCardFee" /> 信用卡付款（店鋪吸收3%手續費）</label>
    </div>

    <div>
      <label>金子純度 (%):</label>
      <label><input type="radio" name="puritySellOut" value="100" checked /> 100%</label>
      <label><input type="radio" name="puritySellOut" value="75" /> 75%</label>
      <label>
        <input type="radio" name="puritySellOut" value="custom" /> 自訂純度:
        <input type="tel" inputmode="numeric" pattern="[0-9]*" id="customPuritySellOut" min="0" max="100" disabled placeholder="0 ~ 100" />
      </label>
    </div>

    <label for="counterofferSellOut">客戶還價 (HKD):</label>
    <input type="tel" inputmode="decimal" pattern="[0-9]*[.,]?[0-9]*" id="counterofferSellOut" placeholder="輸入客戶還價計算利潤" />

    <button id="calcSellOut">計算</button>
    <button id="resetSellOut" style="background-color:#6c757d; margin-top: 5px;">重設</button>

    <div class="result" id="resultSellOut"></div>
    <button id="backFromSellOut" style="background-color:#5bc0de; margin-top: 20px;">返回主頁</button>
  </div>

  <script>
    function showElement(el) { el.classList.remove('hidden'); }
    function hideElement(el) { el.classList.add('hidden'); }

    const homepage = document.getElementById('homepage');
    const buyInCalc = document.getElementById('buyInCalc');
    const sellOutCalc = document.getElementById('sellOutCalc');

    document.getElementById('btnBuyIn').onclick = () => {
      hideElement(homepage);
      showElement(buyInCalc);
      if (buyInLivePrice.textContent === '讀取中...') fetchLivePrice('buyIn');
    };
    document.getElementById('btnSellOut').onclick = () => {
      hideElement(homepage);
      showElement(sellOutCalc);
      if (sellOutLivePrice.textContent === '讀取中...') fetchLivePrice('sellOut');
    };

    document.getElementById('backFromBuyIn').onclick = () => {
      hideElement(buyInCalc);
      showElement(homepage);
    };
    document.getElementById('backFromSellOut').onclick = () => {
      hideElement(sellOutCalc);
      showElement(homepage);
    };

    const buyInLivePrice = document.getElementById('buyInLivePrice');
    const buyInRefresh = document.getElementById('buyInRefresh');
    const sellOutLivePrice = document.getElementById('sellOutLivePrice');
    const sellOutRefresh = document.getElementById('sellOutRefresh');

    let liveGoldPriceHKD = null;

    const METALPRICE_API_KEY = 'b59eca630c98a8dbc001ff5d576db229';
    const USD_TO_HKD = 7.78; // Updated exchange rate
    const TROY_OUNCE_TO_TAEL_RATIO = 31.1035 / 37.429;

    async function fetchLiveGoldPrice() {
      const url = `https://api.metalpriceapi.com/v1/latest?api_key=${METALPRICE_API_KEY}&base=USD&currencies=XAU`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('讀取金價失敗');
        const data = await response.json();

        if (!data.success || !data.rates || !data.rates.XAU) throw new Error('資料錯誤');

        const USDPerOunce = 1 / data.rates.XAU;
        const USDPerTael = USDPerOunce / TROY_OUNCE_TO_TAEL_RATIO;
        const HKDPerTael = USDPerTael * USD_TO_HKD;

        liveGoldPriceHKD = HKDPerTael;
        return HKDPerTael;
      } catch (error) {
        console.error(error);
        liveGoldPriceHKD = null;
        return null;
      }
    }

    async function updateLivePriceElements() {
      if (liveGoldPriceHKD === null) {
        buyInLivePrice.textContent = '錯誤';
        sellOutLivePrice.textContent = '錯誤';
      } else {
        const displayPrice = liveGoldPriceHKD.toFixed(2);
        buyInLivePrice.textContent = displayPrice;
        sellOutLivePrice.textContent = displayPrice;
      }
    }

    async function fetchLivePrice(context) {
      if (liveGoldPriceHKD === null) {
        if (context === 'buyIn') buyInLivePrice.textContent = '讀取中...';
        else if (context === 'sellOut') sellOutLivePrice.textContent = '讀取中...';

        const price = await fetchLiveGoldPrice();
        await updateLivePriceElements();
      }
    }

    buyInRefresh.onclick = () => {
      liveGoldPriceHKD = null;
      fetchLivePrice('buyIn');
    };

    sellOutRefresh.onclick = () => {
      liveGoldPriceHKD = null;
      fetchLivePrice('sellOut');
    };

    const premium500 = document.getElementById('premium500');
    const premium1000 = document.getElementById('premium1000');
    premium500.onclick = () => {
      if (premium500.checked) premium1000.checked = false;
      else premium500.checked = true;
    };
    premium1000.onclick = () => {
      if (premium1000.checked) premium500.checked = false;
      else premium1000.checked = true;
    };

    const purityRadiosBuyIn = document.getElementsByName('purityBuyIn');
    const customPurityBuyIn = document.getElementById('customPurityBuyIn');
    purityRadiosBuyIn.forEach(radio => {
      radio.addEventListener('change', () => {
        customPurityBuyIn.disabled = radio.value !== 'custom';
        if (customPurityBuyIn.disabled) customPurityBuyIn.value = '';
      });
    });

    const purityRadiosSellOut = document.getElementsByName('puritySellOut');
    const customPuritySellOut = document.getElementById('customPuritySellOut');
    purityRadiosSellOut.forEach(radio => {
      radio.addEventListener('change', () => {
        customPuritySellOut.disabled = radio.value !== 'custom';
        if (customPuritySellOut.disabled) customPuritySellOut.value = '';
      });
    });

    document.getElementById('calcBuyIn').onclick = () => {
      const dailyPrice = parseFloat(document.getElementById('dailyPriceBuyIn').value);
      const weight_milliTael = parseFloat(document.getElementById('weightBuyIn').value);
      const discountInput = parseFloat(document.getElementById('discountBuyIn').value);
      const commission = document.getElementById('commissionBuyIn').checked;
      const counterOfferInput = parseFloat(document.getElementById('counterofferBuyIn').value);

      if (isNaN(dailyPrice) || isNaN(weight_milliTael) || weight_milliTael <= 0 || dailyPrice <= 0) {
        alert('請輸入有效的每日金價和重量。');
        return;
      }

      let purityPercent = 100;
      purityRadiosBuyIn.forEach(radio => {
        if (radio.checked) {
          purityPercent = radio.value === 'custom' ? parseFloat(customPurityBuyIn.value) : parseFloat(radio.value);
        }
      });
      if (isNaN(purityPercent) || purityPercent <= 0 || purityPercent > 100) {
        alert('請輸入有效的純度（0到100之間）。');
        return;
      }

      if (liveGoldPriceHKD === null) {
        alert('無法取得即時金價，無法計算利潤');
        return;
      }

      let premium = 0;
      if (premium500.checked) premium = 500;
      else if (premium1000.checked) premium = 1000;

      const livePriceWithPremium = liveGoldPriceHKD - premium; // Deduct premium for buy in

      let basePrice = dailyPrice * (weight_milliTael / 1000) * (purityPercent / 100); // Convert milli tael to tael

      let discount = 1.0;
      if (!isNaN(discountInput) && discountInput > 0) {
        discount = discountInput / 100.0;
      }
      basePrice *= discount;

      if (commission) basePrice *= 0.98;

      const marketPriceTotal = livePriceWithPremium * (weight_milliTael / 1000) * (purityPercent / 100);

      let profitBuyIn = 0;
      let displayOfferPrice = '';

      if (!isNaN(counterOfferInput) && counterOfferInput > 0) {
        profitBuyIn = marketPriceTotal - counterOfferInput;
        displayOfferPrice = `\n客戶還價: HKD ${counterOfferInput.toFixed(2)}`;
      } else {
        profitBuyIn = marketPriceTotal - basePrice;
      }

      document.getElementById('resultBuyIn').innerHTML =
        `買入價格（含佣金及折扣）: HKD ${basePrice.toFixed(2)}<br>` +
        `即時市場價格（扣除溢價）: HKD ${marketPriceTotal.toFixed(2)}${displayOfferPrice}<br>` +
        `<strong>買入利潤: HKD ${profitBuyIn.toFixed(2)}</strong>`;
    };

    document.getElementById('resetBuyIn').onclick = () => {
      document.getElementById('dailyPriceBuyIn').value = '';
      document.getElementById('weightBuyIn').value = '';
      document.getElementById('discountBuyIn').value = '';
      document.getElementById('commissionBuyIn').checked = true;
      premium500.checked = true;
      premium1000.checked = false;
      purityRadiosBuyIn[0].checked = true;
      customPurityBuyIn.value = '';
      customPurityBuyIn.disabled = true;
      document.getElementById('counterofferBuyIn').value = '';
      document.getElementById('resultBuyIn').textContent = '';
    };

    document.getElementById('calcSellOut').onclick = () => {
      const dailyPrice = parseFloat(document.getElementById('dailyPriceSellOut').value);
      const weight_milliTael = parseFloat(document.getElementById('weightSellOut').value);
      const commission = document.getElementById('commissionSellOut').checked;
      const labourCost = parseFloat(document.getElementById('labourCost').value) || 0;
      const creditCard = document.getElementById('creditCardFee').checked;
      const counterOfferInput = parseFloat(document.getElementById('counterofferSellOut').value);

      if (isNaN(dailyPrice) || isNaN(weight_milliTael) || weight_milliTael <= 0 || dailyPrice <= 0) {
        alert('請輸入有效的每日金價和重量。');
        return;
      }

      let purityPercent = 100;
      purityRadiosSellOut.forEach(radio => {
        if (radio.checked) {
          purityPercent = radio.value === 'custom' ? parseFloat(customPuritySellOut.value) : parseFloat(radio.value);
        }
      });
      if (isNaN(purityPercent) || purityPercent <= 0 || purityPercent > 100) {
        alert('請輸入有效的純度（0到100之間）。');
        return;
      }

      if (liveGoldPriceHKD === null) {
        alert('無法取得即時金價，無法計算利潤');
        return;
      }

      let basePrice = dailyPrice * (weight_milliTael / 1000) * (purityPercent / 100);

      if (commission) basePrice *= 1.02;

      basePrice += labourCost;

      const marketPriceTotalSell = liveGoldPriceHKD * (weight_milliTael / 1000) * (purityPercent / 100);

      let profitSellOut = 0;
      let displayOfferPrice = '';

      if (!isNaN(counterOfferInput) && counterOfferInput > 0) {
        profitSellOut = counterOfferInput - marketPriceTotalSell;
        displayOfferPrice = `\n客戶還價: HKD ${counterOfferInput.toFixed(2)}`;
      } else {
        profitSellOut = basePrice - marketPriceTotalSell;
      }

      // Deduct 3% credit card fee cost from profit (absorbed by shop)
      if (creditCard) {
        const creditCardFee = basePrice * 0.03;
        profitSellOut -= creditCardFee;
      }

      document.getElementById('resultSellOut').innerHTML =
        `賣出價格（含佣金，人工費及手續費）: HKD ${basePrice.toFixed(2)}<br>` +
        `即時市場價格: HKD ${marketPriceTotalSell.toFixed(2)}${displayOfferPrice}<br>` +
        `<strong>賣出利潤（含信用卡手續費成本）: HKD ${profitSellOut.toFixed(2)}</strong>`;
    };

    document.getElementById('resetSellOut').onclick = () => {
      document.getElementById('dailyPriceSellOut').value = '';
      document.getElementById('weightSellOut').value = '';
      document.getElementById('commissionSellOut').checked = true;
      document.getElementById('labourCost').value = '';
      document.getElementById('creditCardFee').checked = false;
      purityRadiosSellOut[0].checked = true;
      customPuritySellOut.value = '';
      customPuritySellOut.disabled = true;
      document.getElementById('counterofferSellOut').value = '';
      document.getElementById('resultSellOut').textContent = '';
    };

    fetchLivePrice('buyIn');
  </script>
</body>
</html>
