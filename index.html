<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>King Fai Gold Shop Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: auto; padding: 20px; }
    h1, h2 { text-align: center; }
    .hidden { display: none; }
    button { margin: 5px; padding: 10px 15px; }
    label { display: block; margin: 10px 0 5px; }
    input[type="number"], input[type="text"] { width: 100%; padding: 5px; }
    .checkbox-group { display: flex; gap: 10px; }
    .checkbox-group label { display: flex; align-items: center; gap: 5px; }
    .result { margin-top: 15px; font-weight: bold; font-size: 1.2rem; }
    .price-refresh { cursor: pointer; color: blue; text-decoration: underline; margin-left: 10px; }
  </style>
</head>
<body>
  <h1>King Fai Gold Shop Calculator (HKD)</h1>

  <div id="homepage">
    <button id="btnBuyIn">Buy In Calculator</button>
    <button id="btnSellOut">Sell Out Calculator</button>
  </div>

  <div id="buyInCalc" class="hidden">
    <h2>Buy In Calculator</h2>

    <div>
      <label>Live Gold Price (HKD per gram): 
        <span id="buyInLivePrice">Loading...</span>
        <span id="buyInRefresh" class="price-refresh">Refresh</span>
      </label>
    </div>

    <label for="dailyPriceBuyIn">King Fai Daily Gold Price (HKD/g):</label>
    <input type="number" id="dailyPriceBuyIn" step="0.01" />

    <label for="weightBuyIn">Weight (grams):</label>
    <input type="number" id="weightBuyIn" step="0.01" />

    <div class="checkbox-group">
      <label><input type="checkbox" id="commissionBuyIn" checked /> Deduct 2% commission (Buy In)</label>
    </div>

    <div>
      <label>Gold Purity:</label>
      <label><input type="radio" name="purityBuyIn" value="1" checked /> 100%</label>
      <label><input type="radio" name="purityBuyIn" value="0.75" /> 75%</label>
      <label>
        <input type="radio" name="purityBuyIn" value="custom" /> Custom %:
        <input type="number" id="customPurityBuyIn" min="0" max="1" step="0.01" disabled />
      </label>
    </div>

    <button id="calcBuyIn">Calculate</button>
    <button id="resetBuyIn">Reset</button>

    <div class="result" id="resultBuyIn"></div>
    <button id="backFromBuyIn">Back to Home</button>
  </div>

  <div id="sellOutCalc" class="hidden">
    <h2>Sell Out Calculator</h2>

    <div>
      <label>Live Gold Price (HKD per gram): 
        <span id="sellOutLivePrice">Loading...</span>
        <span id="sellOutRefresh" class="price-refresh">Refresh</span>
      </label>
    </div>

    <label for="dailyPriceSellOut">King Fai Daily Gold Price (HKD/g):</label>
    <input type="number" id="dailyPriceSellOut" step="0.01" />

    <label for="weightSellOut">Weight (grams):</label>
    <input type="number" id="weightSellOut" step="0.01" />

    <div class="checkbox-group">
      <label><input type="checkbox" id="commissionSellOut" checked /> Add 2% commission (Sell Out)</label>
    </div>

    <label for="labourCost">Labour Cost (HKD):</label>
    <input type="number" id="labourCost" step="0.01" />

    <div class="checkbox-group">
      <label><input type="checkbox" id="creditCardFee" /> Add 3% credit card fee</label>
    </div>

    <div>
      <label>Gold Purity:</label>
      <label><input type="radio" name="puritySellOut" value="1" checked /> 100%</label>
      <label><input type="radio" name="puritySellOut" value="0.75" /> 75%</label>
      <label>
        <input type="radio" name="puritySellOut" value="custom" /> Custom %:
        <input type="number" id="customPuritySellOut" min="0" max="1" step="0.01" disabled />
      </label>
    </div>

    <button id="calcSellOut">Calculate</button>
    <button id="resetSellOut">Reset</button>

    <div class="result" id="resultSellOut"></div>
    <button id="backFromSellOut">Back to Home</button>
  </div>

  <script>
    // Utility for element visible toggle
    function showElement(el) { el.classList.remove('hidden'); }
    function hideElement(el) { el.classList.add('hidden'); }

    // Initial setup: references
    const homepage = document.getElementById('homepage');
    const buyInCalc = document.getElementById('buyInCalc');
    const sellOutCalc = document.getElementById('sellOutCalc');

    // Buttons to switch views
    document.getElementById('btnBuyIn').onclick = () => {
      hideElement(homepage);
      showElement(buyInCalc);
      if (buyInLivePrice.textContent === 'Loading...') fetchLivePrice('buyIn');
    };
    document.getElementById('btnSellOut').onclick = () => {
      hideElement(homepage);
      showElement(sellOutCalc);
      if (sellOutLivePrice.textContent === 'Loading...') fetchLivePrice('sellOut');
    };

    // Back buttons
    document.getElementById('backFromBuyIn').onclick = () => {
      hideElement(buyInCalc);
      showElement(homepage);
    };

    document.getElementById('backFromSellOut').onclick = () => {
      hideElement(sellOutCalc);
      showElement(homepage);
    };

    // Live price fields and refresh buttons
    const buyInLivePrice = document.getElementById('buyInLivePrice');
    const buyInRefresh = document.getElementById('buyInRefresh');
    const sellOutLivePrice = document.getElementById('sellOutLivePrice');
    const sellOutRefresh = document.getElementById('sellOutRefresh');

    let liveGoldPriceHKD = null;

    // Fetch live gold price in HKD per gram (convert from per ounce USD)
    // Using Metalprice API: first fetch XAU/USD, then convert USD to HKD (~7.85)
    // For demo, I will fetch XAU price in USD then convert to HKD assuming 31.1 grams per troy ounce and 7.85 HKD/USD exchange rate

    const METALPRICE_API_KEY = 'b59eca630c98a8dbc001ff5d576db229';
    const USD_TO_HKD = 7.85;
    const GRAMS_PER_TROY_OUNCE = 31.1035;

    async function fetchLiveGoldPrice() {
      const url = `https://api.metalpriceapi.com/v1/latest?api_key=${METALPRICE_API_KEY}&base=USD&currencies=XAU`;
      try {
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch price');
        const data = await response.json();

        if (!data.success || !data.rates || !data.rates.XAU) throw new Error('Invalid data');
        // data.rates.XAU is USD per 1 XAU fraction, invert then convert per gram and to HKD
        // The API returns rate as fraction: USD for 1 unit of base in XAU, need inverse
        const USDPerOunce = 1 / data.rates.XAU;
        const USDPerGram = USDPerOunce / GRAMS_PER_TROY_OUNCE;
        const HKDPerGram = USDPerGram * USD_TO_HKD;
        liveGoldPriceHKD = HKDPerGram;
        return HKDPerGram;
      } catch (error) {
        console.error(error);
        liveGoldPriceHKD = null;
        return null;
      }
    }

    async function updateLivePriceElements() {
      if (liveGoldPriceHKD === null) {
        buyInLivePrice.textContent = 'Error';
        sellOutLivePrice.textContent = 'Error';
      } else {
        const displayPrice = liveGoldPriceHKD.toFixed(2);
        buyInLivePrice.textContent = displayPrice;
        sellOutLivePrice.textContent = displayPrice;
      }
    }

    async function fetchLivePrice(context) {
      // context: 'buyIn' or 'sellOut', but updates both fields together
      if (liveGoldPriceHKD === null) {
        if (context === 'buyIn') buyInLivePrice.textContent = 'Loading...';
        else if (context === 'sellOut') sellOutLivePrice.textContent = 'Loading...';

        const price = await fetchLiveGoldPrice();
        await updateLivePriceElements();
      }
    }

    buyInRefresh.onclick = () => {
      liveGoldPriceHKD = null;
      fetchLivePrice('buyIn');
    };

    sellOutRefresh.onclick = () => {
      liveGoldPriceHKD = null;
      fetchLivePrice('sellOut');
    };

    // Purity Radio + custom input behavior for Buy In
    const purityRadiosBuyIn = document.getElementsByName('purityBuyIn');
    const customPurityBuyIn = document.getElementById('customPurityBuyIn');
    purityRadiosBuyIn.forEach(radio => {
      radio.addEventListener('change', () => {
        customPurityBuyIn.disabled = radio.value !== 'custom';
        if (customPurityBuyIn.disabled) customPurityBuyIn.value = '';
      });
    });

    // Purity Radio + custom input behavior for Sell Out
    const purityRadiosSellOut = document.getElementsByName('puritySellOut');
    const customPuritySellOut = document.getElementById('customPuritySellOut');
    purityRadiosSellOut.forEach(radio => {
      radio.addEventListener('change', () => {
        customPuritySellOut.disabled = radio.value !== 'custom';
        if (customPuritySellOut.disabled) customPuritySellOut.value = '';
      });
    });

    // Calculate Buy In
    document.getElementById('calcBuyIn').onclick = () => {
      const dailyPrice = parseFloat(document.getElementById('dailyPriceBuyIn').value);
      const weight = parseFloat(document.getElementById('weightBuyIn').value);
      const commission = document.getElementById('commissionBuyIn').checked;

      if (isNaN(dailyPrice) || isNaN(weight) || weight <= 0 || dailyPrice <= 0) {
        alert('Please enter valid daily price and weight.');
        return;
      }

      let purity = 1;
      purityRadiosBuyIn.forEach(radio => {
        if (radio.checked) {
          purity = radio.value === 'custom' ? parseFloat(customPurityBuyIn.value) : parseFloat(radio.value);
        }
      });
      if (isNaN(purity) || purity <= 0 || purity > 1) {
        alert('Please enter a valid purity between 0 and 1.');
        return;
      }

      // Base price = dailyPrice * weight * purity
      let basePrice = dailyPrice * weight * purity;
      // Deduct 2% commission if applicable
      if (commission) basePrice *= 0.98;

      const resultText = `Buy In Price (after commission): HKD ${basePrice.toFixed(2)}`;
      document.getElementById('resultBuyIn').textContent = resultText;
    };

    // Reset Buy In
    document.getElementById('resetBuyIn').onclick = () => {
      document.getElementById('dailyPriceBuyIn').value = '';
      document.getElementById('weightBuyIn').value = '';
      document.getElementById('commissionBuyIn').checked = true;
      purityRadiosBuyIn[0].checked = true; // 100%
      customPurityBuyIn.value = '';
      customPurityBuyIn.disabled = true;
      document.getElementById('resultBuyIn').textContent = '';
    };

    // Calculate Sell Out
    document.getElementById('calcSellOut').onclick = () => {
      const dailyPrice = parseFloat(document.getElementById('dailyPriceSellOut').value);
      const weight = parseFloat(document.getElementById('weightSellOut').value);
      const commission = document.getElementById('commissionSellOut').checked;
      const labourCost = parseFloat(document.getElementById('labourCost').value) || 0;
      const creditCard = document.getElementById('creditCardFee').checked;

      if (isNaN(dailyPrice) || isNaN(weight) || weight <= 0 || dailyPrice <= 0) {
        alert('Please enter valid daily price and weight.');
        return;
      }

      let purity = 1;
      purityRadiosSellOut.forEach(radio => {
        if (radio.checked) {
          purity = radio.value === 'custom' ? parseFloat(customPuritySellOut.value) : parseFloat(radio.value);
        }
      });
      if (isNaN(purity) || purity <= 0 || purity > 1) {
        alert('Please enter a valid purity between 0 and 1.');
        return;
      }

      // Base price = dailyPrice * weight * purity
      let basePrice = dailyPrice * weight * purity;
      // Add 2% commission if applicable
      if (commission) basePrice *= 1.02;
      // Add labour cost
      basePrice += labourCost;
      // Add 3% credit card fee if applicable
      if (creditCard) basePrice *= 1.03;

      const resultText = `Sell Out Price (incl. commission, labour & fees): HKD ${basePrice.toFixed(2)}`;
      document.getElementById('resultSellOut').textContent = resultText;
    };

    // Reset Sell Out
    document.getElementById('resetSellOut').onclick = () => {
      document.getElementById('dailyPriceSellOut').value = '';
      document.getElementById('weightSellOut').value = '';
      document.getElementById('commissionSellOut').checked = true;
      document.getElementById('labourCost').value = '';
      document.getElementById('creditCardFee').checked = false;
      purityRadiosSellOut[0].checked = true; // 100%
      customPuritySellOut.value = '';
      customPuritySellOut.disabled = true;
      document.getElementById('resultSellOut').textContent = '';
    };

    // On page load, fetch live price for both calculators
    fetchLivePrice('buyIn');
  </script>
</body>
</html>
